<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovFiscal - App Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>.hidden { display: none; }</style>

    <script>
        // Variáveis Globais
        window.lat = 0;
        window.long = 0;
        window.nomeUser = "";
        window.imagemBase64 = null;

        // --- NAVEGAÇÃO ---
        window.entrar = function() {
            const input = document.getElementById('nomeOperario');
            if (!input.value || input.value.length < 3) return alert("Digite seu nome completo.");
            
            window.nomeUser = input.value.toUpperCase();
            
            // Troca Telas
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('appMenu').classList.remove('hidden');
            document.getElementById('userDisplay').innerText = window.nomeUser;
            
            window.iniciarCamera();
            window.buscarGPS();
        }

        window.sair = function() {
            if(confirm("Deseja sair do sistema?")) location.reload();
        }

        window.mudarAba = function(aba) {
            // Reseta visual
            document.getElementById('tabRegistrar').classList.add('hidden');
            document.getElementById('tabHistorico').classList.add('hidden');
            document.getElementById('navReg').classList.remove('text-blue-600');
            document.getElementById('navHist').classList.remove('text-blue-600');

            if(aba === 'registrar') {
                document.getElementById('tabRegistrar').classList.remove('hidden');
                document.getElementById('navReg').classList.add('text-blue-600');
                if(!window.imagemBase64) window.iniciarCamera();
            } else {
                document.getElementById('tabHistorico').classList.remove('hidden');
                document.getElementById('navHist').classList.add('text-blue-600');
                window.carregarHistorico();
            }
        }

        // --- HARDWARE ---
        window.buscarGPS = function() {
            if (!navigator.geolocation) return alert("Erro: Sem GPS.");
            navigator.geolocation.watchPosition(
                (pos) => {
                    window.lat = pos.coords.latitude;
                    window.long = pos.coords.longitude;
                    const btn = document.getElementById('btnBaterPonto');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    btn.classList.add('bg-green-600');
                    btn.innerHTML = '<i class="fas fa-fingerprint"></i> CONFIRMAR PRESENÇA';
                    
                    const gpsTag = document.getElementById('statusGPS');
                    gpsTag.innerText = "GPS ON";
                    gpsTag.classList.replace('bg-red-500', 'bg-green-500');
                },
                (err) => console.log("Erro GPS"),
                { enableHighAccuracy: true }
            );
        }

        window.iniciarCamera = async function() {
            try {
                // facingMode: "user" = Câmera de Selfie (Frontal)
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.classList.remove('hidden');
                document.getElementById('fotoPreview').classList.add('hidden');
            } catch (e) { console.log("Câmera indisponível"); }
        }

        window.carregarFotoArquivo = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 600 / img.width;
                        canvas.width = 600;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        window.imagemBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        
                        document.getElementById('fotoPreview').src = window.imagemBase64;
                        document.getElementById('fotoPreview').classList.remove('hidden');
                        document.getElementById('video').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.capturarFrame = function() {
            const video = document.getElementById('video');
            if (video.classList.contains('hidden')) return null;
            const canvas = document.createElement('canvas');
            canvas.width = 480; canvas.height = 640; // Proporção Selfie
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.6);
        }

        // --- SALVAR ---
        window.salvarPonto = async function() {
            if (!window.db) return alert("Sistema carregando... Aguarde.");
            
            if (!window.imagemBase64) window.imagemBase64 = window.capturarFrame();
            if (!window.imagemBase64) return alert("⚠️ FOTO OBRIGATÓRIA!\nSua selfie comprova que você está no local.");

            const btn = document.getElementById('btnBaterPonto');
            btn.innerHTML = "ENVIANDO...";
            btn.disabled = true;

            try {
                await window.addDoc(window.collection(window.db, "pontos"), {
                    nome: window.nomeUser,
                    data: new Date().toISOString(),
                    data_legivel: new Date().toLocaleString('pt-BR'),
                    localizacao: { lat: window.lat, long: window.long },
                    foto: window.imagemBase64,
                    tipo: "ENTRADA",
                    projeto: "GovFiscal V6"
                });

                alert("✅ PRESENÇA CONFIRMADA!");
                window.imagemBase64 = null;
                window.mudarAba('historico');
                
                // Reseta botão e câmera
                btn.innerHTML = '<i class="fas fa-fingerprint"></i> CONFIRMAR PRESENÇA';
                btn.disabled = false;
                window.iniciarCamera();

            } catch (erro) {
                console.error(erro);
                btn.classList.replace('bg-green-600', 'bg-red-600');
                btn.innerHTML = "ERRO DE ENVIO";
                document.getElementById('boxContingencia').classList.remove('hidden');
                alert("❌ Falha na conexão. Use o formulário de erro abaixo.");
            }
        }

        window.salvarContingencia = async function() {
            const obs = document.getElementById('motivoErro').value;
            if(!obs) return alert("Descreva o erro.");
            
            try {
                await window.addDoc(window.collection(window.db, "pontos"), {
                    nome: window.nomeUser,
                    data: new Date().toISOString(),
                    localizacao: { lat: window.lat, long: window.long },
                    tipo: "⚠️ CONTINGÊNCIA",
                    obs: obs
                });
                alert("Registrado em contingência.");
                document.getElementById('boxContingencia').classList.add('hidden');
                window.mudarAba('historico');
            } catch(e) { alert("Erro fatal. Tire print."); }
        }

        window.carregarHistorico = async function() {
            const lista = document.getElementById('listaHistorico');
            lista.innerHTML = '<p class="text-center text-gray-400">Buscando...</p>';
            
            if(!window.getDocs) return; // Segurança se firebase n carregou

            try {
                const q = window.query(window.collection(window.db, "pontos"), window.where("nome", "==", window.nomeUser));
                const snap = await window.getDocs(q);
                
                let docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => new Date(b.data) - new Date(a.data));

                lista.innerHTML = "";
                if(docs.length === 0) lista.innerHTML = '<p class="text-center mt-4">Sem registros.</p>';

                docs.forEach(d => {
                    const isErro = d.tipo.includes("CONTINGÊNCIA");
                    const cor = isErro ? "red" : "green";
                    const item = `
                        <div class="bg-white p-3 rounded shadow border-l-4 border-${cor}-500 mb-2 flex justify-between items-center">
                            <div>
                                <div class="font-bold text-gray-700">${d.data_legivel ? d.data_legivel.split(',')[1] : "Hoje"}</div>
                                <div class="text-xs text-gray-500">${d.data_legivel ? d.data_legivel.split(',')[0] : ""}</div>
                            </div>
                            <span class="text-${cor}-600 text-xs font-bold bg-${cor}-50 px-2 py-1 rounded">${d.tipo}</span>
                        </div>`;
                    lista.innerHTML += item;
                });
            } catch(e) { lista.innerHTML = '<p class="text-red-500 text-center">Erro ao buscar.</p>'; }
        }
    </script>
</head>

<body class="bg-gray-100 font-sans h-screen flex flex-col">

    <div id="loginScreen" class="fixed inset-0 bg-blue-900 z-50 flex flex-col justify-center items-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <i class="fas fa-landmark text-5xl text-blue-900 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">GovFiscal</h1>
            <p class="text-gray-500 mb-6 text-sm">Acesso Colaborador</p>
            <input type="text" id="nomeOperario" placeholder="SEU NOME COMPLETO" class="w-full p-3 border rounded-lg mb-4 text-center font-bold uppercase">
            <button onclick="window.entrar()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg">ENTRAR</button>
            <p class="mt-4 text-xs text-gray-400">V6.0 - Completo</p>
        </div>
    </div>

    <header id="appHeader" class="hidden bg-blue-900 p-4 text-white flex justify-between items-center shadow-md sticky top-0 z-40">
