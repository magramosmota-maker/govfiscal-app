<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GovFiscal - V19 Final</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        body { overflow: hidden; } 
        
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; top: 30px;
            transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }
        #toast.success { background-color: #166534; }
        #toast.sync { background-color: #ca8a04; }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen w-screen flex flex-col">

    <div id="toast"><i class="fas fa-info-circle"></i> <span>Aviso</span></div>

    <div id="telaLogin" class="fixed inset-0 bg-blue-900 z-50 flex flex-col justify-center items-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <i class="fas fa-landmark text-5xl text-blue-900 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">GovFiscal</h1>
            <p class="text-gray-500 mb-6 text-sm">Fiscaliza√ß√£o Inteligente</p>
            
            <input type="text" id="inputNome" placeholder="SEU NOME" class="w-full p-3 border rounded-lg mb-4 text-center font-bold uppercase focus:ring-2 focus:ring-blue-500 outline-none">
            
            <button onclick="window.app.entrar()" id="btnLogin" class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow-lg transition-transform" disabled>
                CARREGANDO...
            </button>
            
            <p class="mt-4 text-xs font-bold" id="statusConexao">Status: <span class="text-yellow-600">Conectando...</span></p>
            <p class="text-[10px] text-gray-400 mt-2">V19.0 - Conex√£o Est√°vel</p>
        </div>
    </div>

    <div id="telaApp" class="d-none flex-col h-full w-full">
        <header class="bg-blue-900 p-4 text-white flex justify-between items-center shadow-md shrink-0">
            <div class="flex flex-col"><span class="text-[10px] opacity-70 uppercase">Colaborador</span><span class="font-bold text-sm truncate w-24" id="displayNome">...</span></div>
            <div class="flex gap-2 items-center">
                <div id="badgeGPS" class="bg-red-500 px-2 py-1 rounded text-[10px] font-bold shadow">SEM GPS</div>
                <button onclick="window.app.sair()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-1.5 rounded shadow flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> SAIR</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50 pb-32 p-4">
            <div id="abaPonto" class="flex flex-col items-center min-h-full">
                
                <div class="relative w-full max-w-xs aspect-[3/4] bg-gray-800 rounded-2xl overflow-hidden shadow-xl mb-4 border-4 border-white">
                    <video id="videoCam" class="absolute inset-0 w-full h-full object-cover transform -scale-x-100" autoplay playsinline webkit-playsinline></video>
                    <img id="imgPreview" class="absolute inset-0 w-full h-full object-cover d-none">
                    <div id="avisoCamera" class="d-none absolute inset-0 flex flex-col justify-center items-center text-white p-4 text-center">
                        <i class="fas fa-video-slash text-4xl mb-2 opacity-50"></i><p class="text-sm font-bold">C√¢mera Indispon√≠vel</p>
                    </div>
                    <div class="absolute bottom-2 inset-x-0 text-center pointer-events-none"><span class="bg-black/50 text-white text-[10px] px-2 py-1 rounded-full">Selfie Obrigat√≥ria</span></div>
                </div>

                <div class="flex gap-2 w-full max-w-xs mb-4">
                    <button onclick="window.app.inverterCamera()" class="flex-1 bg-white border border-gray-300 text-gray-700 py-3 rounded-lg text-xs font-bold shadow-sm"><i class="fas fa-sync"></i> Inverter</button>
                    <button onclick="document.getElementById('inputNativo').click()" class="flex-1 bg-blue-50 border border-blue-200 text-blue-700 py-3 rounded-lg text-xs font-bold shadow-sm hover:bg-blue-100"><i class="fas fa-camera text-lg"></i> C√¢mera Nativa</button>
                    <input type="file" id="inputNativo" accept="image/*" capture="user" class="d-none" onchange="window.app.processarArquivo(this)">
                </div>

                <button id="btnRegistrar" disabled onclick="window.app.salvar()" class="w-full max-w-xs bg-gray-400 text-white font-bold py-4 rounded-xl shadow-lg text-lg flex items-center justify-center gap-2 opacity-50 cursor-not-allowed transition-all"><i class="fas fa-spinner fa-spin"></i> AGUARDE GPS...</button>

                <div id="painelErro" class="d-none w-full max-w-xs mt-6 bg-yellow-50 border-2 border-yellow-500 p-4 rounded-xl shadow-2xl">
                    <h3 class="text-yellow-800 font-black text-lg mb-2 flex items-center gap-2"><i class="fas fa-wifi"></i> SEM CONEX√ÉO</h3>
                    <p class="text-sm text-yellow-700 mb-3 font-semibold">N√£o foi poss√≠vel conectar ao servidor. Salve no celular:</p>
                    <textarea id="txtErro" class="w-full p-3 text-base border-2 border-yellow-300 rounded-lg mb-4" rows="3" placeholder="Motivo (ex: sem sinal)"></textarea>
                    <button onclick="window.app.salvarLocalmente()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg">SALVAR NO CELULAR</button>
                </div>
            </div>

            <div id="abaHistorico" class="d-none w-full max-w-md mx-auto">
                <div id="boxSync" class="d-none mb-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-md cursor-pointer" onclick="window.app.autoSync()">
                    <div class="flex justify-between items-center">
                        <div><p class="font-bold text-yellow-800">Registros Pendentes</p><p class="text-xs text-yellow-700">Toque aqui para reenviar.</p></div>
                        <i class="fas fa-cloud-upload-alt text-yellow-600 text-2xl animate-bounce"></i>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="font-bold text-gray-700">Meus Registros</h2>
                    <button onclick="window.app.carregarHistorico()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">Atualizar</button>
                </div>
                <div id="listaHistorico" class="space-y-3"></div>
            </div>
        </main>

        <nav class="bg-white border-t flex justify-around p-2 fixed bottom-0 w-full shadow-lg z-50">
            <button onclick="window.app.navegar('ponto')" id="navPonto" class="text-blue-600 flex flex-col items-center w-1/2 p-2"><i class="fas fa-fingerprint text-2xl mb-1"></i><span class="text-[10px] font-bold">REGISTRAR</span></button>
            <button onclick="window.app.navegar('historico')" id="navHist" class="text-gray-400 flex flex-col items-center w-1/2 p-2"><i class="fas fa-list-ul text-2xl mb-1"></i><span class="text-[10px] font-bold">HIST√ìRICO</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwUWRaGbXvjc1NwfnwzDJGCU5EdCK6mcI",
            authDomain: "govfiscal2.firebaseapp.com",
            projectId: "govfiscal2",
            storageBucket: "govfiscal2.firebasestorage.app",
            messagingSenderId: "1025741103658",
            appId: "1:1025741103658:web:aceee319dea96270bd5953"
        };

        // VARI√ÅVEIS DO FIREBASE
        let db = null;

        // INICIALIZA√á√ÉO BLINDADA
        try {
            const fApp = initializeApp(firebaseConfig);
            db = getFirestore(fApp);
            console.log("Firebase Conectado!");
            
            // Ativa o bot√£o de login
            const btnLogin = document.getElementById('btnLogin');
            const status = document.getElementById('statusConexao');
            if(btnLogin) {
                btnLogin.disabled = false;
                btnLogin.classList.replace('bg-gray-400', 'bg-blue-600');
                btnLogin.classList.add('hover:bg-blue-700');
                btnLogin.innerText = "ACESSAR";
            }
            if(status) status.innerHTML = 'Status: <span class="text-green-600">Online üü¢</span>';

        } catch(e) {
            console.error("Erro Firebase:", e);
            document.getElementById('statusConexao').innerHTML = 'Status: <span class="text-red-600">Erro de Rede üî¥</span>';
        }

        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.className = type; t.innerHTML = msg; t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 4000);
        }

        // OBJETO APP (GLOBAL)
        window.app = {
            dados: { lat: 0, long: 0, nome: "", foto: null, modoCam: "user" },
            
            entrar: function() {
                const nome = document.getElementById('inputNome').value;
                if(!nome || nome.length < 3) return alert("Digite seu nome completo!");
                this.dados.nome = nome.toUpperCase();
                document.getElementById('displayNome').innerText = this.dados.nome;
                document.getElementById('telaLogin').classList.add('d-none');
                document.getElementById('telaApp').classList.remove('d-none');
                document.getElementById('telaApp').classList.add('d-flex');
                this.iniciarGPS();
                this.iniciarCamera();
                this.autoSync(); // Tenta sync ao entrar
            },

            sair: function() { if(confirm("Sair?")) location.reload(); },

            navegar: function(tela) {
                if(tela === 'ponto') {
                    document.getElementById('abaPonto').classList.remove('d-none');
                    document.getElementById('abaHistorico').classList.add('d-none');
                    document.getElementById('navPonto').className = "text-blue-600 flex flex-col items-center w-1/2 p-2";
                    document.getElementById('navHist').className = "text-gray-400 flex flex-col items-center w-1/2 p-2";
                    if(!this.dados.foto) this.iniciarCamera();
                } else {
                    document.getElementById('abaPonto').classList.add('d-none');
                    document.getElementById('abaHistorico').classList.remove('d-none');
                    document.getElementById('navPonto').className = "text-gray-400 flex flex-col items-center w-1/2 p-2";
                    document.getElementById('navHist').className = "text-blue-600 flex flex-col items-center w-1/2 p-2";
                    this.carregarHistorico();
                }
            },

            iniciarGPS: function() {
                if(!navigator.geolocation) return alert("Sem GPS");
                navigator.geolocation.watchPosition(pos => {
                    this.dados.lat = pos.coords.latitude;
                    this.dados.long = pos.coords.longitude;
                    const btn = document.getElementById('btnRegistrar');
                    const badge = document.getElementById('badgeGPS');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-fingerprint text-xl"></i> REGISTRAR PRESEN√áA';
                    btn.classList.remove('bg-gray-400', 'opacity-50', 'cursor-not-allowed');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700', 'active:scale-95');
                    badge.innerText = "GPS OK"; badge.classList.replace('bg-red-500', 'bg-green-500');
                }, err => console.log("Erro GPS"), {enableHighAccuracy: true});
            },

            iniciarCamera: async function() {
                const video = document.getElementById('videoCam');
                const aviso = document.getElementById('avisoCamera');
                video.classList.remove('d-none'); aviso.classList.add('d-none');
                
                try {
                    if(window.streamRef) window.streamRef.getTracks().forEach(t => t.stop());
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: this.dados.modoCam } });
                    window.streamRef = stream; video.srcObject = stream;
                    video.style.transform = this.dados.modoCam === 'user' ? "scaleX(-1)" : "scaleX(1)";
                } catch(e) { video.classList.add('d-none'); aviso.classList.remove('d-none'); }
            },

            inverterCamera: function() {
                this.dados.modoCam = this.dados.modoCam === 'user' ? 'environment' : 'user';
                this.iniciarCamera();
            },

            capturarFoto: function() {
                const video = document.getElementById('videoCam');
                if(video.classList.contains('d-none')) return null;
                const canvas = document.createElement('canvas');
                canvas.width = 480; canvas.height = 640;
                const ctx = canvas.getContext('2d');
                if(this.dados.modoCam === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                return canvas.toDataURL('image/jpeg', 0.6);
            },

            processarArquivo: function(input) {
                if(input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgObj = new Image();
                        imgObj.src = e.target.result;
                        imgObj.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const scale = 600/imgObj.width; canvas.width = 600; canvas.height = imgObj.height * scale;
                            ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
                            this.dados.foto = canvas.toDataURL('image/jpeg', 0.6);
                            const preview = document.getElementById('imgPreview');
                            preview.src = this.dados.foto; preview.classList.remove('d-none');
                            document.getElementById('videoCam').classList.add('d-none');
                            document.getElementById('avisoCamera').classList.add('d-none');
                        }
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            salvar: async function() {
                if(!this.dados.foto) this.dados.foto = this.capturarFoto();
                if(!this.dados.foto) return alert("‚ö†Ô∏è FOTO OBRIGAT√ìRIA!");

                const btn = document.getElementById('btnRegistrar');
                const btnOriginal = btn.innerHTML;
                btn.innerHTML = "ENVIANDO..."; btn.disabled = true;

                // TENTA SALVAR NA NUVEM
                try {
                    // Verifica conex√£o e DB
                    if(!db || !navigator.onLine) throw new Error("Offline");

                    await addDoc(collection(db, "pontos"), {
                        nome: this.dados.nome,
                        data: new Date().toISOString(),
                        data_legivel: new Date().toLocaleString('pt-BR'),
                        localizacao: { lat: this.dados.lat, long: this.dados.long },
                        foto: this.dados.foto,
                        tipo: "ENTRADA",
                        projeto: "GovFiscal V19"
                    });
                    
                    showToast("‚úÖ Salvo na Nuvem!", "success");
                    this.dados.foto = null; this.navegar('historico');
                    btn.innerHTML = btnOriginal; btn.disabled = false; this.iniciarCamera();

                } catch(e) {
                    // SE FALHAR, MOSTRA O PAINEL DE CONTING√äNCIA
                    console.log("Erro envio:", e);
                    btn.classList.replace('bg-green-600', 'bg-red-600'); 
                    btn.innerHTML = "FALHA DE REDE";
                    
                    const painel = document.getElementById('painelErro');
                    painel.classList.remove('d-none');
                    setTimeout(() => { 
                        painel.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        document.getElementById('txtErro').focus();
                    }, 500);
                    
                    showToast("‚ö†Ô∏è Erro de conex√£o. Salve no celular.", "sync");
                }
            },

            salvarLocalmente: function() {
                const obs = document.getElementById('txtErro').value;
                if(!obs) return alert("Motivo obrigat√≥rio");
                
                const registro = {
                    nome: this.dados.nome,
                    data: new Date().toISOString(),
                    data_legivel: new Date().toLocaleString('pt-BR'),
                    localizacao: { lat: this.dados.lat, long: this.dados.long },
                    tipo: "‚ö†Ô∏è PENDENTE",
                    obs: obs,
                    foto: "Salva no Aparelho"
                };
                localStorage.setItem('govfiscal_offline_' + Date.now(), JSON.stringify(registro));
                
                showToast("üíæ Salvo no Celular", "sync");
                document.getElementById('painelErro').classList.add('d-none');
                this.navegar('historico');
            },

            autoSync: async function() {
                if(!db || !navigator.onLine) return;
                
                let keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('govfiscal_offline_')) keys.push(key);
                }

                if(keys.length > 0) {
                    showToast(`üîÑ Sincronizando ${keys.length} itens...`, "sync");
                    for(let key of keys) {
                        try {
                            const item = JSON.parse(localStorage.getItem(key));
                            await addDoc(collection(db, "pontos"), {
                                nome: item.nome,
                                data: item.data, data_legivel: item.data_legivel,
                                localizacao: item.localizacao,
                                tipo: "‚ö†Ô∏è CONTING√äNCIA (Sincronizado)",
                                obs: item.obs
                            });
                            localStorage.removeItem(key);
                        } catch(e) { console.log("Erro sync"); }
                    }
                    showToast("‚úÖ Tudo Sincronizado!", "success");
                    this.carregarHistorico();
                }
            },

            carregarHistorico: async function() {
                const lista = document.getElementById('listaHistorico');
                const boxSync = document.getElementById('boxSync');
                
                // Dispara AutoSync
                this.autoSync();

                lista.innerHTML = '<p class="text-center text-gray-400">Buscando...</p>';
                let docs = [];
                let temPendente = false;

                // 1. Busca Local
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('govfiscal_offline_')) {
                        const item = JSON.parse(localStorage.getItem(key));
                        if(item.nome === this.dados.nome) { docs.push(item); temPendente = true; }
                    }
                }
                
                if(temPendente) boxSync.classList.remove('d-none');
                else boxSync.classList.add('d-none');

                // 2. Busca Nuvem
                if(db && navigator.onLine) {
                    try {
                        const q = query(collection(db, "pontos"), where("nome", "==", this.dados.nome));
                        const snap = await getDocs(q);
                        snap.forEach(d => docs.push(d.data()));
                    } catch(e) {}
                }

                docs.sort((a,b) => new Date(b.data) - new Date(a.data));
                lista.innerHTML = "";
                if(docs.length === 0) lista.innerHTML = '<p class="text-center text-gray-400">Sem registros.</p>';

                docs.forEach(d => {
                    const isPendente = d.tipo.includes("PENDENTE");
                    const isSync = d.tipo.includes("Sincronizado");
                    let cor = "green"; let icone = "fa-check-circle";
                    if(isPendente) { cor = "yellow"; icone = "fa-clock"; }
                    if(isSync) { cor = "orange"; icone = "fa-cloud-upload-alt"; }

                    const html = `
                        <div class="bg-white p-3 rounded shadow border-l-4 border-${cor}-500 flex justify-between items-center fade-in">
                            <div>
                                <div class="font-bold text-gray-800">${d.data_legivel ? d.data_legivel.split(',')[1] : "Hoje"}</div>
                                <div class="text-xs text-gray-500">${d.data_legivel ? d.data_legivel.split(',')[0] : ""}</div>
                            </div>
                            <span class="text-${cor}-700 font-bold text-[10px] bg-${cor}-100 px-2 py-1 rounded flex items-center gap-1">
                                <i class="fas ${icone}"></i> ${d.tipo.split(' ')[0]}
                            </span>
                        </div>`;
                    lista.innerHTML += html;
                });
            }
        };
    </script>
</body>
</html>
